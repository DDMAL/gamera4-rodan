<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.15.2: http://docutils.sourceforge.net/" />
<title>kdtree.txt</title>
<link rel="stylesheet" href="default.css" type="text/css" />
</head>
<body>
<div class="document">


<p>b'======================nGamera kd-tree libraryn======================nn**Last modified**: June 03, 2019nn.. contents::nn.. role:: raw-html(raw)n   :format: htmln.. footer:: <a href="#id1"><span class="problematic" id="id2">:raw-html:`&lt;div style=&quot;text-align:right;&quot;&gt;For contact information, see &lt;a href=&quot;http://gamera.informatik.hsnr.de/contact.html&quot;&gt;http://gamera.informatik.hsnr.de/contact.html&lt;/a&gt;&lt;/div&gt;`</span></a>nnnIntroductionn------------nnA <em>kd-tree</em> is multidimensional generalization of a binarynsearch tree. It can be used efficiently for range queries and nearestnneighbor searches, provided the dimension is not to high. In documentnanalysis problems, the dimension is typically two, so that kd-treesncan be a powerful utility for layout analysis problems.nnFor a detailed description of the present kd-tree implementation withnexamples for use cases, seenn  C. Dalitz: <a href="#id8"><span class="problematic" id="id9">`Kd-Trees for Document Layout Analysis.`__</span></a>n  In C. Dalitz (Ed.): &quot;Document Image Analysis with the Gamera Framework.&quot;n  Schriftenreihe des Fachbereichs Elektrotechnik und Informatik,n  Hochschule Niederrhein, vol. 8, pp. 39-52, Shaker Verlag (2009)nn.. __: <a class="reference external" href="http://lionel.kr.hsnr.de/~dalitz/data/publications/sr09-kdtree-layout.pdfnnAdditional">http://lionel.kr.hsnr.de/~dalitz/data/publications/sr09-kdtree-layout.pdfnnAdditional</a> background information on kd-trees can be found in the nfollowing literature:nn- for an introduction to kd-trees and basic properties, see <a href="#id11"><span class="problematic" id="id3">[deBerg2000]_</span></a>n- more algorithms for kd-trees can be found in the original article n  <a href="#id12"><span class="problematic" id="id4">[Bentley1975]_</span></a>n- neither of the above two references covers nearest neighborn  searches in kd-trees; these are coverd in <a href="#id13"><span class="problematic" id="id5">[Friedman1977]_</span></a>nnnExamplesn--------nnHere is an example for looking up the three nearest neighbors tona given point from a set of sample points:nn.. code:: Pythonnn   from gamera.kdtree import <em>nn   points = [(1,4), (2,4), (1,5), (3,6), (8,9),n             (2,7), (4,4), (5,5), (4,6), (8,3)]n   nodes = [KdNode(p) for p in points]n   tree = KdTree(nodes)nn   # neighbors to a sample point not from the setn   point = [5,6]n   k = 3n   knn = tree.k_nearest_neighbors(point, k)n   print &quot;%i neighbors of (%i,%i):&quot; % (k,point[0], point[1]),n   for node in knn:n       print &quot;(%i,%i)&quot; % (node.point[0], node.point[1]),n   print &quot;&quot; # final newlinenn   # neighbors to a sample point from the setn   # we must query k+1 neighbors, because one of them isn   # the sample point (the first entry in the returned list)n   point = [5,5]n   k = 3n   knn = tree.k_nearest_neighbors(point, k+1)n   print &quot;%i neighbors of (%i,%i):&quot; % (k,point[0], point[1]),n   for node in knn[1:]:n       print &quot;(%i,%i)&quot; % (node.point[0], node.point[1]),n   print &quot;&quot; # final newlinennThe property *KdNode.data</em> can store an arbitrary Python objectnassociated with the point. The following example represents eachnconnected component by its middle point and stores the actualnCC with the point in the node:nn.. code:: Pythonnn   ccs = image.cc_analysis()n   nodes = [KdNode([cc.center.x,cc.center.y], cc) for cc in ccs]nnIt is also possible to search for only those neighbors that fulfilna certain predicate. To this end, you must define a function or callablenclass that takes a KdNode as input and returns <tt class="docutils literal">True</tt> when it fulfilsnthe search predicate. The following example only returns nearest neighborsnbelow the search point:nn.. code:: Pythonnn   # predicate definition as callable classn   class predicate(object):n       def __init__(self, point):n           self.point = pointn       def __call__(self, node):n           return (point[1] &gt; node.point[1])nn   # find the three nearest neighbors belown   point = (5,6)n   knn = tree.k_nearest_neighbors(point, 3, predicate(point))nnBeware however, that a search predicate can have the effect thatnless than k neighbors are returned, because too few nodes fulfilnthe predicate. In such a case, the runtime is O(n) instead of O(log(n)).nIn other words, a poorly chosen search predicate can have a considerablennegative impact on the runtime. In some cases, modifying the distance metricn(method <em>set_distance</em>) can be an alternative to a search predicaten[Dalitz09]_.nnnThe Kd-Tree Python APIn----------------------nnn``KdNode`` objectsn''''''''''''''''''nnEach <tt class="docutils literal">KdNode</tt> has two properties:nn <em>point</em>n   The geometric location of the node as a sequence of coordinaten   numbers. The coordinate numbers can be floats or ints.n   This is an immutable property, because changing the geometricn   location of nodes belonging to an already built kd-tree obviouslyn   breaks subsequent search operations.nn <em>data</em>n   An arbitrary Python object connected to the location <em>point</em>.nn.. docstring:: gamera.kdtree KdNodenn``KdTree`` objectsn''''''''''''''''''nnEach kd-tree is represented by instances of the <tt class="docutils literal">KdTree</tt> class.nEven though there are general kd-tree algorithms to add and removennodes dynamically (see <a href="#id14"><span class="problematic" id="id6">[Bentley1975]_</span></a>), the present implementationndoes not support alteration of a once built tree. This has thenconsequence that tree nodes must be passed to the constructor ofn``KdTree``.nnA <tt class="docutils literal">KdTree</tt> has the following (read only) properties:nn <em>dimension</em>n   The dimension of the kd-tree. This is automatically determinedn   by the constructor.nn.. docstring:: gamera.kdtree KdTreenn.. docstring:: gamera.kdtree KdTree set_distancenn.. docstring:: gamera.kdtree KdTree k_nearest_neighborsnnnThe Kd-Tree C++ APIn-------------------nnThe module <tt class="docutils literal">gamera.kdtree</tt> is only a thin Python wrapper aroundna C++ class <tt class="docutils literal">KdTree</tt>. This can also be used directly in C++ plugins.nnCompilation and linkagen'''''''''''''''''''''''nnThe header file <em>kdtree.hpp</em> declares the necessary structures innthe namespace <tt class="docutils literal"><span class="pre">Gamera::Kdtree</span></tt>. It is installed with the other gameranheader files, and can thus be included withnn.. code:: CPPnn   #include &quot;geostructs/kdtree.hpp&quot;n   using namespace Gamera::Kdtree;nnThe tricky part is getting your plugin module to be linked with thenactual kdtree implementation. This is achieved by adding thensource file <tt class="docutils literal">kdtree.cpp</tt> to the <tt class="docutils literal">cpp_sources</tt> property in thenplugin Python interface.nnIn the gamera core code, the following works:nn.. code:: Pythonnn   class ExampleModule(PluginModule):n       category = &quot;MyPlugins&quot;n       cpp_headers = [&quot;myplugins.hpp&quot;]n       cpp_sources = [&quot;src/geostructs/kdtree.cpp&quot;]n       functions = [myplugin1, myplugin2]n   module = ExampleModule()nnIn a toolkit, this will not work, because the path names innthe <tt class="docutils literal">cpp_sources</tt> property are relative to the locationnof the <em>setup.py</em> script. To allow for the use of the KdTree C++nclass in toolkits, the source file <em>kdtree.cpp</em> is installed togethernwith Gamera. You can thus specify this file in <tt class="docutils literal">cpp_sources</tt>nas follows:nn.. code:: Pythonnn   class ExampleModule(PluginModule):n       # ...n       import os, sys, gameran       gamera_root = os.path.dirname(gamera.__file__)n       cppfile = os.path.join(gamera_root,&quot;src/geostructs/kdtree.cpp&quot;)n       if not os.path.exists(cppfile):n           gamera_root = os.path.join(sys.exec_prefix,&quot;gamera&quot;)n           cppfile = os.path.join(gamera_root,&quot;src/geostructs/kdtree.cpp&quot;)n       cpp_sources=[cppfile]n       # ...nnQuerying the installation directory is a bit tricky, because the pythonndistutils do not install additional <em>data_files</em> in a predictable way:nthey might go into the gamera installation directory, whichncan be found out through the <em>__file__</em> property of the gamera module, ornthey might go into <em>sys.exec_prefix/gamera</em> (this is what the distutilsndocumentation says, but apparently this does not hold on all platforms).nnnUsagen'''''nnFor normal use of the kdtree, you will need the classes n``CoordPoint`` (a typedef for <tt class="docutils literal">vector&lt;double&gt;</tt>), <tt class="docutils literal">KdNode</tt>, n``KdNodeVector``, and <tt class="docutils literal">KdTree</tt>. Beside the property <tt class="docutils literal">point</tt>, an``KdNode`` can also store an arbitrary pointer as <tt class="docutils literal">data</tt>. Seenthe header file <em>kdtree.hpp</em> for details.nnHere is a usage example for a nearest neighbor search:nn.. code:: CPPnn   // set points for building the treen   KdNodeVector nodes;n   double points[][2] = {n     {1,4}, {2,4}, {1,5}, {3,6}, {8,9},n     {2,7}, {4,4}, {5,5}, {4,6}, {8,3},n     {-20,-20} // array terminatorn   };n   size_t i;n   for (i=0; points[i][0]&gt;=-1.0; i++) {n     CoordPoint p;n     p.push_back(points[i][0]);n     p.push_back(points[i][1]);n     nodes.push_back(KdNode(p));n   }nn   // build the treen   KdTree tree(&amp;nodes);nn   // find the three nearest neighbors to (5,6)n   KdNodeVector neighbors;n   CoordPoint point(2);n   point[0] = 5;n   point[1] = 6;n   tree.k_nearest_neighbors(point, 3, &amp;neighbors);nnIf you want to restrict the returned neighbors to only those fulfillingna specific search predicate, you can define your search predicate asna callable class (aka <em>functor</em>, i.e. a class with the call operatorn``operator()`` overwritten <a href="#id15"><span class="problematic" id="id7">[Stroustrup1997]_</span></a>) derived from n``KdNodePredicate`` as in the following example:nn.. code:: CPPnn   // only search for nodes on the right hand side of search pointn   struct MyPredicate : public KdNodePredicate {n     CoordPoint point(2);n     MyPredicate(CoordPoint&amp; p) {n       point = p;n     }n     bool operator()(const KdNode&amp; kn) const {n       return point[0] &lt; kn.point[0];n     }n   };nnThe call of the class only takes a single argument, the <tt class="docutils literal">KdNode</tt>, andnreturns true when this node is an admissible search result. If thisncriterion depends on some information from the actual search point (likenits <em>x</em>-component in the exampel above), this information must be passed tonthe class constructor and stored within the class.nnAn instance of this class can then be passed as the third, optional argumentnto <tt class="docutils literal">KdTree.k_nearest_neighbors</tt>:nn.. code:: CPPnn   KdNodeVector neighbors;n   CoordPoint point(2);n   point[0] = 5;n   point[1] = 6;n   MyPredicate predicate(point);n   tree.k_nearest_neighbors(point, 3, &amp;neighbors, &amp;predicate);nnnReferencesn----------nn.. [deBerg2000] M. de Berg, M. van Kreveld, M. Overmars, O. Schwarzkopf:n   <em>Computational Geometry.</em> Second edition, Springer (2000)nn.. [Bentley1975] J.L. Bentley: <em>Multidimensional Binary Search Trees Usedn   for Associative Searching.</em> Communications of the ACM 18,n   pp. 509-517 (1975)nn.. [Friedman1977] J.H. Friedman, J.L. Bentley, R.A. Finkel:n   <em>An Algorithm for Finding Best Matches in Logarithmic Expected Time.</em>n   ACM Transcations on Mathematical Software 3, pp. 209-226 (1977)nn.. [Stroustrup1997] Stroustrup, B. 1997. <em>The C++ Programmingn   Language: Third Edition.</em>  Reading, MA: Addison-Wesley.nn.. [Dalitz09] C. Dalitz: <a href="#id8"><span class="problematic" id="id10">`Kd-Trees for Document Layout Analysis.`__</span></a>n  In C. Dalitz (Ed.): &quot;Document Image Analysis with the Gamera Framework.&quot;n  Schriftenreihe des Fachbereichs Elektrotechnik und Informatik,n  Hochschule Niederrhein, vol. 8, pp. 39-52, Shaker Verlag (2009)nn.. __: <a class="reference external" href="http://lionel.kr.hsnr.de/~dalitz/data/publications/sr09-kdtree-layout.pdfn">http://lionel.kr.hsnr.de/~dalitz/data/publications/sr09-kdtree-layout.pdfn</a>'</p>
<div class="system-message" id="id1">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">./src/kdtree.txt</tt>, line 1); <em><a href="#id2">backlink</a></em></p>
Unknown interpreted text role &quot;raw-html&quot;.</div>
<div class="system-messages section">
<h1>Docutils System Messages</h1>
<div class="system-message" id="id8">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">./src/kdtree.txt</tt>, line 2); <em>backlinks: <a href="#id9">1</a>, <a href="#id10">2</a></em></p>
Anonymous hyperlink mismatch: 2 references but 0 targets.
See &quot;backrefs&quot; attribute for IDs.</div>
<div class="system-message" id="id11">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">./src/kdtree.txt</tt>, line 1); <em><a href="#id3">backlink</a></em></p>
Unknown target name: &quot;deberg2000&quot;.</div>
<div class="system-message" id="id12">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">./src/kdtree.txt</tt>, line 1); <em><a href="#id4">backlink</a></em></p>
Unknown target name: &quot;bentley1975&quot;.</div>
<div class="system-message" id="id13">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">./src/kdtree.txt</tt>, line 1); <em><a href="#id5">backlink</a></em></p>
Unknown target name: &quot;friedman1977&quot;.</div>
<div class="system-message" id="id14">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">./src/kdtree.txt</tt>, line 1); <em><a href="#id6">backlink</a></em></p>
Unknown target name: &quot;bentley1975&quot;.</div>
<div class="system-message" id="id15">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">./src/kdtree.txt</tt>, line 1); <em><a href="#id7">backlink</a></em></p>
Unknown target name: &quot;stroustrup1997&quot;.</div>
</div>
</div>
</body>
</html>
